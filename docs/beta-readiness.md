# Готовность к бета-релизу Pulse

Краткий чек-лист: что уже есть и что стоит доделать перед выходом в бета.

---

## Уже сделано (по ТЗ и плану)

- **API v1**: auth (login/logout/me), чаты (фильтры, пагинация, assign-me, close, typing), сообщения (курсорная пагинация, send с вложениями и client_message_id), uploads, devices (FCM), canned-responses. OpenAPI и api-v1.md актуальны.
- **Filament чат**: вкладки (мои/нераспределённые/все), поиск и фильтр по статусу (открытые/закрытые), «Загрузить предыдущие», вложения (скрепка), шаблоны ответов, индикатор «печатает», Realtime (Echo на `chat.{id}`).
- **Вебхуки**: VK и Telegram принимают сообщения, очередь (ProcessIncomingMessageJob), рассылка NewChatMessage в Reverb.
- **Входящие вложения**: DownloadInboundAttachmentJob скачивает файлы в медиа и обновляет payload сообщения (локальный диск; для продакшена можно переключить на S3/MinIO).
- **Виджет**: session, messages, send; скрипт pulse-widget.js.
- **Обработка ошибок API**: JSON-ответы для 401, 403, 404, 422 (в bootstrap/app.php).
- **Health**: маршрут `/up` для проверки живости приложения.

---

## Обязательно перед бета (инфра и конфиг)

1. **Очередь и кэш в проде**  
   В бета/проде обязательно:
   - `QUEUE_CONNECTION=redis` и запущен воркер:  
     `php artisan queue:work redis --tries=3 --timeout=90`
   - `CACHE_STORE=redis`  
   Иначе вебхуки будут обрабатываться синхронно и возможны таймауты, а rate limit для Telegram может вести себя нестабильно.

2. **Reverb (WebSockets)**  
   - Запуск: `php artisan reverb:start` (или через supervisor).
   - Для HTTPS: Nginx-прокси WSS на порт Reverb (см. README), в `.env` выставить `REVERB_HOST`/порт так, чтобы клиенты подключались по `wss://ваш-домен`.

3. **FCM (push)**  
   - В коде используется `config('services.fcm.server_key')`, но в `config/services.php` секция `fcm` отсутствует — ключ не подхватывается.
   - **Сделать**: добавить в `config/services.php` секцию `fcm` с `server_key` и в `.env.example` переменную `FCM_SERVER_KEY` (и опционально документировать в README). Без этого push просто не отправляется (job тихо пропускается).

4. **Хранилище медиа в проде (ТЗ п. 2.1)**  
   - Сейчас загрузки и входящие вложения идут на `local`/диск по `FILESYSTEM_DISK`.
   - Для беты можно оставить диск, но для продакшена по ТЗ нужен S3 (или MinIO): настроить диск в `config/filesystems.php`, выставить `FILESYSTEM_DISK=s3` и при необходимости правки в медиа-конфиге Spatie.

5. **Исключение «онлайн» модераторов из FCM (ТЗ п. 3.3)**  
   - Сейчас push уходит всем модераторам с доступом к чату.
   - По ТЗ нужно не слать push тем, кто «сейчас Online» (Reverb presence или кэш). Для беты можно отложить и слать всем; для полного соответствия ТЗ — доработать SendFcmPushNotificationJob (например, помечать онлайн через presence канал Reverb или кэш по user_id и отфильтровывать при выборе device_tokens).

---

## Желательно для беты

6. **Лимиты на API**  
   - На `api/v1/*` можно включить throttle (например, `throttle:60,1` на группу маршрутов), чтобы защититься от злоупотреблений. Сейчас явного throttle на API v1 нет.

7. **Логирование и мониторинг**  
   - Убедиться, что в проде `LOG_CHANNEL`/`LOG_LEVEL` адекватны (не `debug` в проде).
   - При желании: логировать критические действия (ошибки вебхуков, падения FCM, ошибки очереди) в отдельный канал или в систему мониторинга.

8. **Тесты**  
   - API v1 и ChatPageTest проходят. Остальные падающие тесты (Auth, PasswordReset, Registration, 2FA, Settings) связаны с сессией/CSRF и сценариями Fortify — их стоит починить для уверенности в регрессиях перед бета.

9. **Документация деплоя**  
   - В README уже есть раздел Production (queue worker, Nginx для Reverb). Имеет смысл добавить короткий чек-лист деплоя (миграции, очереди, Reverb, Redis, .env для беты) и упоминание FCM (после добавления конфига).

---

## Можно отложить после беты

- **Typing от клиента (Telegram)**: по ТЗ — «бэкенд слушает вебхук chat_action»; в Telegram Bot API входящих событий «клиент печатает» нет, только исходящий sendChatAction. Реалистичный вариант — только «модератор печатает» (уже есть через POST typing).
- **Desktop-клиент**: папка в .gitignore; для беты достаточно веб-админки (Filament) и при необходимости мобильного/десктопного клиента по тому же API v1.
- **Полноценный S3 для всех медиа**: если бета с одним сервером и локальным диском приемлема, S3 можно ввести позже.

---

## Итоговый минимум для выхода в бета

1. В проде: Redis, очередь (`queue:work`), Reverb (и при необходимости Nginx для WSS).  
2. Добавить конфиг FCM (`config/services.php` + `.env.example`) и при необходимости — исключение онлайн-модераторов из push.  
3. Проверить `.env` беты (APP_DEBUG=false, APP_ENV=production/staging, ключи, БД, Redis, Reverb, опционально FCM).  
4. (Рекомендуется) Починить падающие тесты Auth/Settings и добавить throttle на API v1.  
5. (Рекомендуется) Краткий деплой-чек-лист в README или в этом файле.

После этого приложение можно считать готовым к бета-релизу с точки зрения функционала и эксплуатации.
